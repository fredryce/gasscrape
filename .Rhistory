mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
corona_lag_new
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map()
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(urbnmapr)
library(gganimate)
library(ggthemes)
library(fiftystater)
library(tibble)
library(lubridate)
library(reticulate)
library(scales)
average_county_price <- data_with_county %>%
group_by(id_value, date) %>%
summarise(average_price_daily=mean(price), county=head(unique(county), 1)) %>%
group_by(county, date) %>%
summarise(price = mean(average_price_daily)) %>%
mutate(lag_price=lag(price), price_change=price-lag_price)
data_count <- average_county_price %>%
group_by(county) %>%
count(sort = T) %>%
head(10)
average_county_price
top_20 <- left_join(data_count, average_county_price, by="county")
average_county_price <- data_with_county %>%
group_by(id_value, date) %>%
summarise(average_price_daily=mean(price), county=head(unique(county), 1)) %>%
group_by(county, date) %>%
summarise(price = mean(average_price_daily)) %>%
mutate(lag_price=lag(price), price_change=price-lag_price)
data_count <- average_county_price %>%
group_by(county) %>%
count(sort = T) %>%
head(10)
top_10 <- left_join(data_count, average_county_price, by="county")
head(top_10)
top_10 %>%
ggplot(aes(x=date, y=price, color=county)) +
geom_point() +
geom_smooth(se = F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x= date, y=price_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x=date, y=price, color=county)) +
geom_point() +
geom_smooth(se = F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x=date, y=price, color=county)) +
geom_point() +
geom_smooth(se = F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x=date, y=price, color=county)) +
geom_point() +
geom_smooth(se = F, method = "lm") +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x=date, y=price, color=county)) +
geom_point() +
geom_smooth(se = F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x= date, y=price_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
top_10 %>%
ggplot(aes(x= date, y=price_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
covid_data<- df %>%
filter(state=="Florida") %>%
mutate(date=ymd(date), county=paste0(county, " County")) %>%
filter(date>=ymd("2020-03-26")) %>%
right_join(data_count, by="county") %>%
group_by(county, date) %>%
summarise(cases=cases) %>%
mutate(lag_case=lag(cases), new_cases=cases-lag_case, case_change_lag= lag(new_cases), case_change=new_cases-case_change_lag)
head(covid_data)
covid_data %>%
ggplot(aes(x=date, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
covid_data %>%
ggplot(aes(x=date, y=case_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
df <- read.csv("https://query.data.world/s/xhb3ss5oasu2ashiy2hdujwmtyhrzd", header=TRUE, stringsAsFactors=FALSE)
head(df)
covid_data<- df %>%
filter(state=="Florida") %>%
mutate(date=ymd(date), county=paste0(county, " County")) %>%
filter(date>=ymd("2020-03-26")) %>%
right_join(data_count, by="county") %>%
group_by(county, date) %>%
summarise(cases=cases) %>%
mutate(lag_case=lag(cases), new_cases=cases-lag_case, case_change_lag= lag(new_cases), case_change=new_cases-case_change_lag)
head(covid_data)
covid_data %>%
ggplot(aes(x=date, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
covid_data %>%
ggplot(aes(x=date, y=case_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
covid_data %>%
ggplot(aes(x=date, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F) +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
covid_data %>%
ggplot(aes(x=date, y=case_change, color=county)) +
geom_line() +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
todays_date = today() - 10
corona_lag <- df %>%
mutate(county_fips=as.character(fips), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
df %>%  #my assumption is that each date and each county would only conatin one value
group_by(state, county, date) %>%  #cant only group by county have to groupy by state
count(sort=T)
corona_all <- left_join(counties, corona_lag, by="county_fips")
corona_all
corona_all %>%  #why is it like this, no data for california??
ggplot(aes(long, lat, group=group, fill=cases)) +
geom_polygon()
todays_date = today() - 10
corona_lag <- df %>%
mutate(county_fips=as.character(fips), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
corona_all <- left_join(counties, corona_lag, by="county_fips")
corona_all
corona_all %>%  #why is it like this, no data for california??
ggplot(aes(long, lat, group=group, fill=cases)) +
geom_polygon()
corona_lag %>%
filter(state=="California")
counties %>%
filter(state_abbv=="CA")
corona_lag %>%
filter(state=="California") %>%
head()
counties %>%
filter(state_abbv=="CA") %>%
head()
formatC(1001, width = 5, flag="0", format="fg")
corona_lag_new <- df %>%
mutate(county_fips=formatC(fips, width = 5, flag="0", format = "fg"), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
corona_lag_new
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map() +
annotate("text", x = -120, y=50, label = todays_date)
formatC(1001, width = 5, flag="0", format="fg")
corona_lag_new <- df %>%
mutate(county_fips=formatC(fips, width = 5, flag="0", format = "fg"), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
head(corona_lag_new)
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map() +
annotate("text", x = -120, y=50, label = todays_date)
#formatC(1001, width = 5, flag="0", format="fg")
corona_lag_new <- df %>%
mutate(county_fips=formatC(fips, width = 5, flag="0", format = "fg"), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
head(corona_lag_new)
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map() +
annotate("text", x = -120, y=50, label = todays_date)
todays_date = today() - 4
corona_lag <- df %>%
mutate(county_fips=as.character(fips), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
corona_all <- left_join(counties, corona_lag, by="county_fips")
corona_all
corona_all %>%  #why is it like this, no data for california??
ggplot(aes(long, lat, group=group, fill=cases)) +
geom_polygon()
#formatC(1001, width = 5, flag="0", format="fg")
corona_lag_new <- df %>%
mutate(county_fips=formatC(fips, width = 5, flag="0", format = "fg"), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
head(corona_lag_new)
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map() +
annotate("text", x = -120, y=50, label = todays_date)
#formatC(1001, width = 5, flag="0", format="fg")
corona_lag_new <- df %>%
mutate(county_fips=formatC(fips, width = 5, flag="0", format = "fg"), date=as.Date(date)) %>%
group_by(state, county, date) %>%
summarise(county_fips=county_fips, cases=cases) %>%
mutate(case_lag=lag(cases), new_case=cases-case_lag) %>%
filter(date==todays_date)
head(corona_lag_new)
corona_all_new <- left_join(counties, corona_lag_new, by="county_fips") %>%
mutate(cases=case_when(is.na(cases)~as.integer(0), TRUE~cases))
corona_all_new %>%
ggplot(aes(long, lat, group=group, fill=log(cases))) +
borders("county") +
geom_polygon() +
scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
theme_map() +
annotate("text", x = -120, y=50, label = todays_date)
covid_data
top_10
merged_df <- left_join(top_10, covid_data, by=c("county", "date")) %>%
print() %>%
select(county, date, price_change, case_change, new_cases, price)
merged_df %>%
gather("price_change":"case_change", key="data_type", value="value") %>%
print() %>%
ggplot(aes(x=date, y=value, color=county)) +
geom_line(size=0.5) +
facet_grid(rows=vars(data_type), scales = "free") +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
#covid_data
#top_10
merged_df <- left_join(top_10, covid_data, by=c("county", "date")) %>%
select(county, date, price_change, case_change, new_cases, price)
head(merged_df)
merged_df %>%
gather("price_change":"case_change", key="data_type", value="value") %>%
ggplot(aes(x=date, y=value, color=county)) +
geom_line(size=0.5) +
facet_grid(rows=vars(data_type), scales = "free") +
scale_x_date(date_breaks="1 day") +
theme(axis.text.x = element_text(angle = 60, hjust = 1))
merged_df
merged_df %>%
ggplot(aes(x=price, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm", fullrange=TRUE)
merged_df %>%
ggplot(aes(x=price, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm", fullrange=TRUE)
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
print(i)
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
print()  %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(lag_1, lag_3, lag_5, lag_7, lag_9, lag_10) %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
gather("lag_1":"lag_10", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
print() %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8"))
gather("lag_1":"lag_7", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8"))
gather("lag_1":"lag_7", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8"))
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
merged_df %>%
ggplot(aes(x=price, y=new_cases, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm", fullrange=TRUE)
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8"))
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
gather("lag_1":"lag_9", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
generate_lag_frame <- function(x, column_name, lagg=10){
for(i in 1:lagg){
x <- x %>%
mutate(!!paste0("lag_", i) := as.numeric(lag(eval(parse(text = column_name)),n = i, default = "0")))
}
return(x)
}
merged_df %>%
generate_lag_frame("new_cases") %>%
select(-c("lag_2", "lag_4", "lag_6", "lag_8")) %>%
gather("lag_1":"lag_7", key="lag_number", value="value") %>%
ggplot(aes(x=price, y=value, color=county)) +
geom_point() +
geom_smooth(se=F, method="lm")+
facet_wrap(vars(lag_number))
